image: "ubuntu"

stages:
  - build
  - release

variables:
  ADDON_NAME: "Heracles"
  ZIP_FILE: "${ADDON_NAME}.zip"
  EXCLUDES: "--exclude=README.md --exclude=.gitlab-ci.yml"

build_addon:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache zip
  script:
    - echo "Zippage de l'addon sans les fichiers exclus..."
    - zip -r "$ZIP_FILE" . $EXCLUDES
  artifacts:
    paths:
      - ${ZIP_FILE}
  rules:
    - if: $CI_COMMIT_TAG

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Création de la release pour ${ADDON_NAME}"
  release:
    name: "Release $CI_COMMIT_TAG"
    tag_name: "$CI_COMMIT_TAG"
    description: "Release générée automatiquement pour $ADDON_NAME"
    assets:
      links:
        - name: "${ZIP_FILE}"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_REF_NAME}/raw/${ZIP_FILE}?job=build_addon"
  rules:
    - if: $CI_COMMIT_TAG